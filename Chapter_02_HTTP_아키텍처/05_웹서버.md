# 5. 웹서버

## 5.1 다채로운 웹서버
- 웹서버: 웹서버 소프트웨어, 웹페이지 제공에 특화된 장비(컴퓨터..) -> 리소스에 대한 HTTP 요청을 받아서 콘텐츠를 클라이언트에 줌
    - HTTP와 TCP 처리를 구현한 것
    - HTTP 프로토콜을 구현, 리소스 관리, 웹 서버 관리, TCP 커넥션 관리 책임
    
1) 다목적 소프트웨어 웹서버
    - 네트워크에 연결된 표준 컴퓨터 시스템에서 동작함
    - 예) 마이크로소프트 웹 서버, 아파치 웹 서버, nginx
2) 임베디드 웹서버
    - 일반 소비자용 제품에 내장될 목적으로 만들어진 작은 웹서버(프린터 등)
    
## 5.2 웹 서버가 하는 일
- 커넥션 맺고
- 요청 받아서 처리
- 리소스에 접근
- 응답을 만들어서 보내고
- 트랜잭션을 로그로 만든다

### 5.2.1 클라이언트 커넥션 수락

1) 새 커넥션 다루기
    - 클라이언트 -> 웹서버에 TCP 커넥션 요청
    - 웹서버는 커넥션 맺고 TCP 커넥션에서 IP주소를 추출하여 클라이언트 확인
    - 커넥션을 거절하거나 닫을 수 있다
    
2) 클라이언트 호스트명 식별    
    - 역방향 DNS를 통해 IP주소를 호스트명으로 변환하도록 설정되어 있음 -> 호스트명 룩업은 트랜잭션을 느려지게 할 수 있음
    - 호스트명을 접근체어와 로깅에 사용
    
3) ident를 통해 클라이언트 사용자 알아내기
    - IETF ident 프로토콜 지원
        - 서버에게 어떤 사용자 이름이 HTTP 커넥션을 초기화했는지 찾아낼 수 있게 함(웹 서버 로깅에 유용)
        - 일반 로그포맷의 두번째 필드는 HTTP 요청의 ident사용자 이름을 가짐
    - 클라이언트가 ident 프로토콜을 지원하면 TCP 113 포트를 listen
    - 클라이언트가 HTTP 커넥션 열고 -> 서버는 커넥션을 identd 서버포트(113)을 향해 열고) -> 새 커넥션에 대응하는 사용자 이름을 묻는 요청을 보낸다
    - but, 클라이언트 PC는 대게 identd 신원확인 프로토콜 데몬 소프트웨어를 실행하지 않고
    - ident 프로토콜은 HTTP 트랜잭션을 지연시키고
    - 방화벽이 ident 트래픽을 막는 경우도 많고
    - ident 프로토콜은 안전하지 않고 조작하기 쉽고
    - 가상 IP 주소를 잘 지원하지 않아서 잘 동작하지 않는다.
    
### 5.2.2 요청메세지 수신
- 커넥션에 데이터가 도착하면 읽고 파싱하여 요청 메시지를 구성함
- 파싱할 때
    - 요청 메서드, 리소스 식별자(URI), 버전번호를 찾는다(요청줄은 CRLF로 끝남)
    - 메시지 헤더를 읽음(CRLF로 끝남)
    - 요청 본문이 있으면 읽음(Content-Length로 길이 정의)
- 몇몇 서버는 요청메시지를 내부의 자료구조에 저장
- 고성능 웹서버는 수청 개 커넥션을 동시에 열 수 있도록 지원

1. 단일 스레드 웹서버
    - 한 번에 요청 하나씩 처리
    - 트랜잭션이 완료되면 다음 커넥션 처리
    - 처리 중 다른 커넥션은 모두 무시됨
2. 멀티프로세스와 멀티스레드 웹서버
    - 여러 요청을 동시에 처리
    - 커넥션마다 스레드/프로세스 하나를 할당하지만 엄청난 커넥션을 처리하면 많은 메모리를 낭비하므로 최대 스레드/프로세스 갯수에 제한을 둔다
3. 다중 I/O 서버
    - 대량 커넥션 지원을 위해 다중 아키텍처 채택
    - 모든 커넥션은 감시를 당함 
    - 커넥션에 실제 해야할 일이 있을 때 커넥션에 대해 작업을 수행
    - 유휴상태의 커넥션에 스레드/프로세스가 매여 낭비되지 않도록 함
4. 다중 멀티스레드 웹 서버
    - 멀티스레딩 + 다중화
    
### 5.2.3 요청 처리
- 요청을 받으면 메서드, 리소스, 헤더, (본문)을 얻어 처리

### 5.2.4 리소스 매핑과 접근
- 웹소스는 리소스 서버다
- HTML 페이지나 jpeg 이미지 같은 미리 만들어진 콘텐츠 제공
- 리소스 생성 애플리케이션을 통해 만들어진 동적 콘텐츠도 제공

1. Docroot
    - 요청 URI를 웹서버 파일 시스템 안에 있는 파일 이름으로 사용
    - 파일시스템 내 폴더를 웹 콘텐츠를 위해 예약해 둠 => 문서루트(docroot)
    - 요청메시지에서 URI를 가져와서 문서루트 뒤에 붙임
    - 예) 요청리소스 ```/specials/test.jpeg``` -> 웹서버의 문서루트 ```/usr/local/httpd/files/``` 반환하는 파일경로 ```/uer/local/httpd/files/specials/test.jpeg'```
2. 가상호스팅된 docroot
    - 가상호스팅 웹서버는 사이트마다 분리된 문서루트를 준다
    - URI나 호스트 헤더에서 얻은 IP주소나 호스트명을 통해 문서루트 식별 => 하나의 웹 서버에서도 다른 사이트가 각각 분리된 콘텐츠를 가짐

3. 사용자 홈 디렉토리 docroots
    - 한 대의 웹서버에서 각자 개인의 웹사이트를 만들 수 있도록 해줌
    - ```/~(사용자 이름)```
    
- 파일 url이 아닌 디렉토리 url 요청을 받을 수도 있음
    - 그럼 에러 반환함
    - 디렉터리 대신 색인파일(index.html) 반환
    - 디렉터리를 탐색해서 그 내용을 담은 html페이지 반환 -> 없으면 디렉터리 파일들을 크기, 변경일, 파일링크와 열거한 html파일 반환
    
- url을 동적 리소스에 매핑 => 요청에 맺게 콘텐츠 생성 프로그램에 url 매핑하는 것
    - 애플리케이션 서버: 웹서버를 백엔드 애플리케이션과 연결시켜줌. 동적 콘텐츠 생성 프로그램이 어딨고 어떻게 실행하는지 알려줌
- 서버사이드 인클루드: 리소스의 콘텐츠를 클라이언트에 보내기 전에 처리
- 접근제어
    - 각 리소스에 접근 제어 할당
    - 접근제어 리소스에 대해 요청이 도착하면 클라이언트 IP주소에 근거하여 접근을 제어하거나 비번을 묻거나 할 수 있다
    
### 5.2.5 응답 만들기
1. 응답 엔터티
    - 트랜잭션이 응답 본문을 생성하면 본문을 응답과 보냄
    - 본문에는
        - Content-Type 헤더: 본문 MIME 타입 서술 
        - Content-Length 헤더: 본문 길이
        - 본문 내용 이 포함된다
    
2. MIME 타입 결정
    - mime.types: 파일이름의 확장자를 사용하여 타입(확장자 기반 타입 연계)
    - 매직 타이핑: 파일의 내용을 검사해서 턴에 대한 테이블에 해당하는 패턴 확인. 확장자 없는 파일의 타입을 알아낼 때 편리
    - 유형명시: 특정 파일, 디렉터리 내 파일이 확장자나 내용에 상관없이 어떤 MIME 타입을 갖게 하는지 설정
    - 유형협상: 리소스가 여러 종류의 문서 형식에 속할 때 사용자와의 협상을 통해 가장 사용하기 좋은 형식을 판별

3. 리다이랙션
    - 성공대신 리다이랙션 반환(3XX 코드)
    - 리소스가 영구적으로 옮겨졌을 때(301)
    - 임시로 리소스가 옮겨졌을 때(303, 307) -> 클라이언트가 나중에는 원래 url로 오고 북마크도 갱신하지 않길 바람
    - 상태 정보를 포함한 새 url을 생성하고 사용자가 이쪽으로 오도록 리다이렉트(303, 307) -> 트랜잭션 간 상태를 유지하는데 좋음
    - 과부화된 요청을 받을 때. 부하가 덜 한 서버로 리다이렉트(303, 307)
    - 요청 클라이언트 정보를 가진 다른 서버가 있을 때(303, 307)
    - 디렉터리 이름 url을 요청하는데 /을 빠뜨렸을 때
    
### 5.2.6 응답 보내기
- 서버는 커넥션 상태를 추적해야 하며 지속적 커넥션을 다룰 때 주의 필요
- 비지속적 커넥션: 응답 보내고 커넥션 닫음
- 지속적 커넥션일 때 서버가 Content-Length 계산에 특별한 주의가 필요한 경우나 클라이언트 응답이 언제 끝나는지 알 수 없을 때 커넥션은 열린 상태 유지

### 5.2.7 로깅
- 트랜잭션이 완료되면 어떻게 수행되었는지에 대한 로그를 로그파일에 기록
